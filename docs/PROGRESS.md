# Endure — Progress Log

## 2026-02-07

- Backend domain spine generated:
  - models + relationships
  - migrations
  - policies
  - API resources
  - API controllers (stubbed)
  - API routes
- Added `role` to users (`athlete`, `coach`, `admin`)
- Registered policy mappings for core training entities
- API auth decision recorded: use Fortify/session `auth` middleware (no Sanctum in baseline)
- Phase 2A started: dashboard now reads real training plan data from `GET /api/training-plans` (nested weeks/sessions), read-only
- Added frontend transformer layer for training plan API payloads to keep UI decoupled from raw response shape
- Dashboard data loading moved to Inertia server props (no client-side fetch for plan reads)
- Implemented TrainingWeek read endpoints (`index`, `show`) with policy-aware scoping and nested sessions
- Added read performance controls for TrainingPlan + TrainingWeek index endpoints:
  - `per_page`
  - `starts_from`
  - `ends_to`
  - paginated response shape (`data`, `links`, `meta`)
- Added/updated API tests for:
  - training plan pagination + date filters
  - training week read access behavior
  - authenticated endpoint behavior updates
- Implemented TrainingSession read endpoints (`index`, `show`) for calendar backbone
- Added TrainingSession read filters:
  - `from`
  - `to`
  - `training_plan_id`
  - `training_week_id`
- Added TrainingSession read tests for:
  - auth requirements
  - athlete own-data access
  - athlete forbidden cross-user access
  - admin full access
  - coach empty collection behavior
  - date window filtering
- Implemented TrainingWeek CRUD (`store`, `update`, `destroy`) with policy checks
- Added explicit TrainingWeek write validation via FormRequests:
  - required `starts_at` / `ends_at`
  - date ordering (`starts_at < ends_at`)
  - non-overlapping weeks within the same training plan
- Added focused TrainingWeek CRUD API tests for auth, ownership, admin, overlap, and invalid date ranges
- Added deterministic visual verification seeders:
  - `VisualSeeder`
  - `Visual/AdminVisualSeeder`
  - `Visual/CoachVisualSeeder`
  - `Visual/AthleteVisualSeeder`
  - deterministic role users + predictable plan/week/session calendar data
- Implemented role-aware navigation shells (athlete/coach/admin/settings route surfaces)
- Refactored athlete calendar to slicing-first composition using real backend data:
  - single calendar canvas
  - fixed top calendar header
  - fixed weekday row
  - sticky week headers
  - 7 aligned day columns + right weekly summary rail
  - read-only interaction posture preserved
- Reworked sidebar from starter-kit panel navigation to slicing-style fixed icon rail:
  - icon stack + active blue indicator dot
  - role-aware nav visibility retained
  - role badge + sign-out controls aligned to slicing layout
- Removed/neutralized starter-kit visual token drift:
  - slicing-aligned dark tokens in `resources/css/app.css`
  - Inter + JetBrains Mono font loading in app shell
  - bootstrap background set to slicing dark to avoid initial flash mismatch
- Updated calendar session visuals toward slicing `SessionCard` behavior:
  - removed planned badge
  - status icon rules aligned
  - mono metric row + left sport accent strip + density/rhythm parity updates
- Updated docs to track frontend slicing convergence and backend readiness

## 2026-02-08

- Completed athlete calendar visual parity hardening pass (frontend-only, read-only behavior unchanged):
  - scroll ownership locked to calendar canvas (page wrapper overflow hidden)
  - duplicate day-column vertical separators removed
  - current-week emphasis reduced to subtle header treatment (no full-week tint / left stripe)
  - weekly summary rail width adjusted to slicing proportions
  - week/day vertical rhythm normalized for consistent band height
  - day-cell inset spacing tightened for closer date-to-session scan flow
  - planned-session contrast increased (title + primary duration metric)
  - session metrics restructured to stacked mono duration/TSS blocks
  - planned-state right-side marker aligned to slicing composition
- Verified frontend safety with targeted TypeScript check (`npm run types`) after the pass.
- No backend/API/routes/policy changes in this update.
- Implemented TrainingSession write support (backend-only):
  - added `StoreTrainingSessionRequest`
  - added `UpdateTrainingSessionRequest`
  - added enum-backed sport validation via `TrainingSessionSport` (`swim`, `bike`, `run`, `gym`, `other`)
  - enforced session date within selected `TrainingWeek` range
  - enforced week accessibility validation for athlete/admin write paths
- Implemented `TrainingSessionController` write methods:
  - `store` returns `201` + `TrainingSessionResource`
  - `update` returns `200` + `TrainingSessionResource`
  - `destroy` returns `204`
  - policy checks applied for create/update/delete; coach write access remains denied
- Added `tests/Feature/Api/TrainingSessionCrudApiTest.php` covering:
  - auth required
  - athlete own create/update/delete
  - athlete forbidden cross-athlete mutation
  - admin full mutation
  - coach forbidden (`403`)
  - validation failures for invalid week, date outside week range, missing required fields
- Verification completed:
  - `vendor/bin/sail bin pint --dirty --format agent`
  - `vendor/bin/sail artisan test --compact tests/Feature/Api/TrainingSessionCrudApiTest.php tests/Feature/Api/TrainingSessionReadApiTest.php tests/Feature/Api/TrainingWeekReadApiTest.php tests/Feature/Api/TrainingWeekCrudApiTest.php` (23 passed)
- Wired athlete-only TrainingSession write interactions into calendar UI (frontend-only):
  - create modal triggered from empty day cells / add button
  - edit modal triggered from session row click
  - delete action with explicit confirmation in edit modal
  - all writes call existing API routes (`store` / `update` / `destroy`) via Wayfinder route helpers
  - backend validation errors render inline in the modal
  - successful writes reload calendar data from real backend props
  - role gating enforced: only `auth.user.role === 'athlete'` can trigger write affordances; non-athletes remain read-only
- Frontend verification completed:
  - `vendor/bin/sail npm run types`
- Implemented coach-athlete assignment backbone (backend-first):
  - added `coach_athlete_assignments` table with:
    - `coach_id` FK
    - `athlete_id` FK
    - unique `(coach_id, athlete_id)`
    - cascading deletes
  - added `CoachAthleteAssignment` model
  - added `User` relationships:
    - `coachedAthletes()`
    - `coaches()`
- Updated assignment-aware authorization and read scoping:
  - policies now allow coach read access only for assigned athletes
  - coach write access remains denied for plans/weeks/sessions/activities
  - dashboard + API read controllers (`TrainingPlan`, `TrainingWeek`, `TrainingSession`) now scope coach collections to assigned athletes only
- Implemented read-only coach view enablement:
  - added `CoachAthleteIndexController` for assigned-athlete directory props
  - added `AthleteCalendarController` for coach/admin athlete calendar viewing
  - wired `/coaches` to assigned-athlete directory with real Inertia props
  - wired `/athletes/{athlete}` to reuse existing calendar page in read-only coach context
  - added contextual calendar header text: `Viewing athlete: {name}`
  - kept athlete calendar composition unchanged
- Extended deterministic visual seeders:
  - seeded three deterministic athletes with plans/weeks/sessions
  - seeded one coach assigned to all three athletes
- Added/updated tests:
  - `tests/Feature/CoachAthleteAssignmentTest.php`
  - `tests/Feature/CoachCalendarReadAccessTest.php`
  - updated existing coach read assertions in plan/week/session read API tests for assignment-aware behavior
- Validation completed:
  - `vendor/bin/sail bin pint --dirty --format agent`
  - `vendor/bin/sail npm run types`
  - `vendor/bin/sail artisan test --compact tests/Feature/CoachAthleteAssignmentTest.php tests/Feature/CoachCalendarReadAccessTest.php tests/Feature/Api/TrainingPlanReadApiTest.php tests/Feature/Api/TrainingPlanCrudApiTest.php tests/Feature/Api/TrainingWeekReadApiTest.php tests/Feature/Api/TrainingWeekCrudApiTest.php tests/Feature/Api/TrainingSessionReadApiTest.php tests/Feature/Api/TrainingSessionCrudApiTest.php tests/Feature/NavigationShellPagesTest.php tests/Feature/DashboardTest.php` (46 passed)

- Implemented admin console + impersonation system (session-based, read-only-first):
  - added admin-only route guard middleware (`admin`)
  - added admin routes:
    - `GET /admin`
    - `GET /admin/users`
    - `POST /admin/impersonate/{user}`
    - `POST /admin/impersonate/stop`
  - added backend controllers:
    - `AdminConsoleController`
    - `AdminUserIndexController`
    - `ImpersonationStartController`
    - `ImpersonationStopController`
  - added Inertia shared impersonation context:
    - `auth.impersonating`
    - `auth.original_user`
    - `auth.impersonated_user`
- Corrected admin navigation behavior to slicing rules:
  - admin (not impersonating) sidebar now shows only:
    - Admin Console
    - Users
  - impersonated sessions now show role-correct sidebar automatically
- Added persistent impersonation banner with stop action across app layout.
- Enforced read-only training writes during impersonation:
  - write-policy guard for plan/week/session/activity create/update/delete/restore/forceDelete
  - API routes now include session middleware (`StartSession`) so impersonation context is available for policy enforcement
- Added admin impersonation + role-navigation test coverage:
  - `tests/Feature/AdminImpersonationTest.php`
  - updated `tests/Feature/NavigationShellPagesTest.php`
- Validation completed:
  - `vendor/bin/sail bin pint --dirty --format agent`
  - `vendor/bin/sail npm run types`
  - `vendor/bin/sail artisan test --compact tests/Feature/AdminImpersonationTest.php tests/Feature/NavigationShellPagesTest.php tests/Feature/CoachAthleteAssignmentTest.php tests/Feature/CoachCalendarReadAccessTest.php tests/Feature/Api/TrainingPlanReadApiTest.php tests/Feature/Api/TrainingPlanCrudApiTest.php tests/Feature/Api/TrainingWeekReadApiTest.php tests/Feature/Api/TrainingWeekCrudApiTest.php tests/Feature/Api/TrainingSessionReadApiTest.php tests/Feature/Api/TrainingSessionCrudApiTest.php` (54 passed)

- Implemented provider-agnostic external activity read scaffolding (backend-only):
  - added provider contract:
    - `app/Services/ActivityProviders/Contracts/ActivityProvider.php`
  - added normalized DTO + typed collection:
    - `app/Data/ExternalActivityDTO.php`
    - `app/Data/Collections/ActivityCollection.php`
  - added provider manager/registry with allowed-provider enforcement:
    - `app/Services/ActivityProviders/ActivityProviderManager.php`
  - added explicit provider exceptions:
    - unsupported provider
    - unauthorized
    - invalid token
    - rate limited
    - token missing
    - request failure
  - container wiring added in `AppServiceProvider` with provider map from `config/services.php`

- Implemented Strava read-only provider:
  - `app/Services/ActivityProviders/Strava/StravaActivityProvider.php`
  - read endpoints used:
    - `/athlete/activities`
    - `/activities/{id}`
  - centralized HTTP client setup (base URL + bearer token + JSON)
  - explicit failure handling for:
    - missing token
    - invalid/expired token (`401`)
    - unauthorized (`403`)
    - rate limit (`429`)
  - explicit mapping from Strava payload to normalized DTO fields

- Added minimal persistence layer for normalized provider activities:
  - `app/Services/Activities/ExternalActivityPersister.php`
  - upsert by (`athlete_id`, `provider`, `external_id`)
  - no training-session linking or derived metrics

- Extended schema for external activity storage:
  - `users`:
    - `strava_access_token`
    - `strava_refresh_token`
    - `strava_token_expires_at`
  - `activities`:
    - renamed `source` → `provider`
    - added `athlete_id`, `sport`, `started_at`, `duration_seconds`, `distance_meters`, `elevation_gain_meters`
    - made `training_session_id` nullable
    - added indexes + unique constraint on (`athlete_id`, `provider`, `external_id`)

- Implemented read-only activities API:
  - controller:
    - `ActivityController@index`
    - `ActivityController@show`
  - routes:
    - `GET /api/activities`
    - `GET /api/activities/{activity}`
  - request validation:
    - `per_page`
    - `provider`
    - `from` / `to`
  - role-scoped access:
    - athlete: own activities
    - coach: assigned athletes only
    - admin: all
  - pagination shape preserved (`data`, `links`, `meta`)

- Added/updated tests:
  - `tests/Feature/ActivityProviders/ActivityProviderManagerTest.php`
  - `tests/Feature/ActivityProviders/StravaActivityProviderTest.php`
  - `tests/Feature/Api/ActivityReadApiTest.php`
  - updated `tests/Feature/Api/DomainSpineRoutesTest.php` for implemented activities index

- Validation completed:
  - `vendor/bin/sail bin pint --dirty --format agent`
  - `vendor/bin/sail artisan test --compact tests/Feature/ActivityProviders/ActivityProviderManagerTest.php tests/Feature/ActivityProviders/StravaActivityProviderTest.php tests/Feature/Api/ActivityReadApiTest.php tests/Feature/Api/DomainSpineRoutesTest.php` (14 passed)
  - `vendor/bin/sail artisan test --compact tests/Feature/Api/TrainingPlanReadApiTest.php tests/Feature/Api/TrainingWeekReadApiTest.php tests/Feature/Api/TrainingSessionReadApiTest.php tests/Feature/Api/TrainingPlanCrudApiTest.php tests/Feature/Api/TrainingWeekCrudApiTest.php tests/Feature/Api/TrainingSessionCrudApiTest.php tests/Feature/CoachCalendarReadAccessTest.php` (39 passed)

- Implemented provider-agnostic OAuth connection and sync backbone (Strava first):
  - added OAuth provider contract:
    - `app/Services/ActivityProviders/Contracts/OAuthProvider.php`
  - added normalized OAuth token DTO:
    - `app/Data/OAuthProviderTokensDTO.php`
  - extended provider manager to resolve both:
    - activity providers
    - OAuth providers
- Added durable provider connection persistence:
  - new table + model:
    - `activity_provider_connections`
    - `App\Models\ActivityProviderConnection`
  - stores:
    - encrypted `access_token`
    - encrypted `refresh_token`
    - `token_expires_at`
    - provider athlete id
    - sync tracking (`last_synced_at`, `last_sync_status`, `last_sync_reason`)
- Implemented Strava OAuth provider (read scopes, connect/callback/refresh support):
  - `app/Services/ActivityProviders/Strava/StravaOAuthProvider.php`
  - OAuth endpoints wired against:
    - `https://www.strava.com/oauth/authorize`
    - `https://www.strava.com/oauth/token`
- Implemented centralized token lifecycle management:
  - `ActivityProviderTokenManager` detects near-expiry and refreshes tokens through OAuth provider abstractions
  - `ActivityProviderConnectionStore` handles upsert/disconnect/sync status updates and legacy Strava token compatibility
- Implemented sync orchestration:
  - `ActivitySyncService` fetches provider activities, persists via `ExternalActivityPersister`, and tracks sync status
  - added API endpoint:
    - `POST /api/activity-providers/{provider}/sync`
  - role behavior:
    - athlete/admin allowed
    - coach forbidden
- Implemented web OAuth routes/controllers (auth-protected):
  - connect redirect
  - callback exchange/store
  - disconnect
  - routes under `settings/connections/*`
- Added Settings → Connections UI (Inertia, real backend state, no mock data):
  - `resources/js/pages/settings/connections.tsx`
  - shows connection status + last sync + connect/disconnect + sync now
  - wired into settings navigation and settings overview links
- Config/environment updates:
  - expanded `config/services.php` for OAuth provider map + Strava OAuth credentials/scopes + sync refresh settings
  - added required env variables to `.env.example`
- Added test coverage:
  - `tests/Feature/Settings/ActivityProviderConnectionsTest.php`
  - `tests/Feature/Api/ActivityProviderSyncApiTest.php`
  - `tests/Unit/ActivityProviders/ActivityProviderTokenManagerTest.php`
  - updated `tests/Feature/ActivityProviders/ActivityProviderManagerTest.php` for OAuth provider resolution
- Validation completed:
  - `vendor/bin/sail bin pint --dirty --format agent`
  - `vendor/bin/sail npm run types`
  - `vendor/bin/sail artisan test --compact tests/Feature/Settings/ActivityProviderConnectionsTest.php tests/Feature/Api/ActivityProviderSyncApiTest.php tests/Feature/ActivityProviders/ActivityProviderManagerTest.php tests/Feature/ActivityProviders/StravaActivityProviderTest.php tests/Feature/Api/ActivityReadApiTest.php tests/Unit/ActivityProviders/ActivityProviderTokenManagerTest.php` (27 passed)

- Upgraded provider sync to queue-backed execution with lock safety:
  - added sync run tracking model/table:
    - `ActivityProviderSyncRun`
    - `activity_provider_sync_runs`
  - added async dispatcher + job:
    - `ActivitySyncDispatcher`
    - `SyncActivityProviderJob`
  - sync endpoint behavior changed:
    - `POST /api/activity-providers/{provider}/sync`
    - now returns `202` + queued payload (`status`, `provider`, `sync_run_id`)
  - one sync lock per `provider + user` enforced via cache lock
  - deterministic retry/backoff implemented:
    - lock-contention release delay
    - rate-limit-aware requeue (uses `Retry-After` when provided; otherwise exponential delay)
  - connection sync statuses expanded in practice:
    - `queued`
    - `running`
    - `rate_limited`
    - `failed`
    - `success`

- Added Strava webhook ingestion + verification (Strava-first, provider-safe structure):
  - new webhook routes:
    - `GET /api/webhooks/strava` (verification handshake)
    - `POST /api/webhooks/strava` (event ingestion)
  - new webhook persistence model/table:
    - `ActivityProviderWebhookEvent`
    - `activity_provider_webhook_events`
  - idempotent event storage enforced by unique (`provider`, `payload_hash`)
  - processing behavior:
    - `create` / `update` activity events queue targeted sync for connected athlete
    - `delete` activity events soft-delete matching local activity record
    - unsupported/unmapped events are stored and marked ignored
  - optional subscription-id matching supported through config for stricter ingestion safety

- Added soft-delete support for external activities:
  - migration:
    - `add_deleted_at_to_activities_table`
  - `Activity` now uses `SoftDeletes`
  - persister restored to handle upserts against previously deleted activity rows

- Updated settings connections UX for async sync lifecycle:
  - sync action now expects `202 queued`
  - sync status labels rendered from real backend connection state (`queued`, `running`, `rate_limited`, `failed`, `success`)
  - no fake status data introduced

- Added/updated tests for queue + webhook hardening:
  - `tests/Feature/Api/ActivityProviderSyncApiTest.php`
  - `tests/Feature/Api/ActivityProviderSyncJobTest.php`
  - `tests/Feature/Api/ActivityProviderWebhookTest.php`
  - existing provider/token/read/settings tests kept green

- Validation completed:
  - `vendor/bin/sail bin pint --dirty --format agent`
  - `vendor/bin/sail npm run types`
  - `vendor/bin/sail artisan test --compact tests/Feature/Api/ActivityProviderSyncApiTest.php tests/Feature/Api/ActivityProviderWebhookTest.php tests/Feature/Api/ActivityProviderSyncJobTest.php tests/Feature/Api/ActivityReadApiTest.php tests/Feature/Settings/ActivityProviderConnectionsTest.php tests/Feature/ActivityProviders/ActivityProviderManagerTest.php tests/Feature/ActivityProviders/StravaActivityProviderTest.php tests/Unit/ActivityProviders/ActivityProviderTokenManagerTest.php` (34 passed)

- Enabled real-time sync status updates with Laravel Reverb:
  - installed broadcasting + Reverb scaffolding (`config/broadcasting.php`, `config/reverb.php`, `routes/channels.php`)
  - added broadcast event:
    - `ActivityProviderSyncStatusUpdated`
  - wired sync status transitions to broadcast from `ActivityProviderConnectionStore`
  - private user channel used:
    - `App.Models.User.{id}`
  - settings connections page now subscribes via Echo and reloads provider data when status events arrive
  - queue/webhook/status behavior unchanged functionally; this step adds live UI propagation only
  - Sail container networking updated for Reverb websocket traffic:
    - exposed container port `8080` via `FORWARD_REVERB_PORT`
- Frontend Echo setup completed:
  - added `resources/js/lib/echo.ts`
  - initialized Echo on app boot in `resources/js/app.tsx`
  - added CSRF meta tag in app root view for private channel auth
  - installer-injected `@laravel/echo-react` import was replaced with explicit `laravel-echo` + `pusher-js` setup for deterministic control
- Added event assertions to sync tests:
  - queued status event dispatched from sync API queueing flow
  - running/success/rate_limited events dispatched from sync job flow
- Validation completed after Reverb wiring:
  - `vendor/bin/sail bin pint --dirty --format agent`
  - `vendor/bin/sail npm run types`
  - `vendor/bin/sail artisan test --compact tests/Feature/Api/ActivityProviderSyncApiTest.php tests/Feature/Api/ActivityProviderSyncJobTest.php tests/Feature/Api/ActivityProviderWebhookTest.php tests/Feature/Settings/ActivityProviderConnectionsTest.php tests/Feature/Api/ActivityReadApiTest.php tests/Feature/ActivityProviders/ActivityProviderManagerTest.php tests/Feature/ActivityProviders/StravaActivityProviderTest.php tests/Unit/ActivityProviders/ActivityProviderTokenManagerTest.php` (34 passed)

- Implemented read-only Activity ↔ TrainingSession linking hints (backend-only):
  - added `ActivityLinkingService` for deterministic suggestion queries by:
    - athlete ownership
    - same sport
    - same calendar date
    - unlinked activities only
    - duration proximity ordering
  - updated `TrainingSessionResource` to include `suggested_activities` (minimal fields only)
  - updated `ActivityResource` to expose `linked_session_id` (+ `linked_session_uid` helper)
  - confirmed no write endpoints, no auto-linking, and no metric derivation were introduced
- Added linking-focused tests:
  - `tests/Feature/Services/ActivityLinkingServiceTest.php`
  - `tests/Feature/Api/ActivityLinkingResourceTest.php`
- Validation completed:
  - `vendor/bin/sail bin pint --dirty --format agent`
  - `vendor/bin/sail artisan test --compact tests/Feature/Services/ActivityLinkingServiceTest.php tests/Feature/Api/ActivityLinkingResourceTest.php tests/Feature/Api/TrainingSessionReadApiTest.php tests/Feature/Api/ActivityReadApiTest.php` (20 passed)

- Implemented manual Activity ↔ TrainingSession linking (explicit actions, no auto-binding):
  - added API endpoints:
    - `POST /api/training-sessions/{training_session}/link-activity`
    - `DELETE /api/training-sessions/{training_session}/unlink-activity`
  - added FormRequests:
    - `LinkActivityToSessionRequest`
    - `UnlinkActivityFromSessionRequest`
  - controller-level validation and guards now enforce:
    - session policy authorization (`linkActivity`, `unlinkActivity`)
    - same-athlete ownership between session/activity
    - conflict rejection when activity is linked elsewhere
    - conflict rejection when session already has a different linked activity
  - admin link/unlink is blocked by policy unless admin is impersonating an athlete (then treated as athlete context)
- Updated API resource contracts:
  - `TrainingSessionResource` now includes:
    - `linked_activity_id`
    - `linked_activity_summary`
    - `suggested_activities` (computed only for session show context)
  - `ActivityResource` now includes:
    - `linked_session_summary` when relation is loaded
- Frontend calendar wiring (athlete-only link UX):
  - session editor modal now shows:
    - linked activity summary
    - suggested activities list
    - explicit Link / Unlink actions with loading and error feedback
  - role gating updated:
    - athletes can link/unlink
    - coaches/admins do not see link controls
    - impersonated athlete context can access link/unlink controls while session write fields remain read-only
  - session rows show subtle linked-activity indicator
- Added/updated tests:
  - `tests/Feature/Api/TrainingSessionActivityLinkApiTest.php`
  - `tests/Feature/Api/ActivityLinkingResourceTest.php` (extended)
- Validation completed:
  - `vendor/bin/sail bin pint --dirty --format agent`
  - `vendor/bin/sail npm run types`
  - `vendor/bin/sail artisan test --compact tests/Feature/Api/TrainingSessionActivityLinkApiTest.php tests/Feature/Api/ActivityLinkingResourceTest.php tests/Feature/Services/ActivityLinkingServiceTest.php tests/Feature/Api/TrainingSessionReadApiTest.php tests/Feature/Api/TrainingSessionCrudApiTest.php tests/Feature/AdminImpersonationTest.php tests/Feature/Api/ActivityReadApiTest.php` (44 passed)

Next milestone:
→ Add provider operational hardening phase: webhook subscription lifecycle management + background worker deployment guidance + scheduled sync orchestration (no metrics derivation yet).
